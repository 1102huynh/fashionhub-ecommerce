---
import EcommerceLayout from '../layouts/EcommerceLayout.astro';
---

<EcommerceLayout title="My Account - FashionHub" description="Manage your FashionHub account">
	<div class="account-container">
		<!-- Welcome Banner -->
		<div id="welcome-banner" class="welcome-banner" style="display: none;">
			<div class="welcome-content">
				<h2>üéâ Welcome to FashionHub!</h2>
				<p>Your account has been created successfully. Start shopping now!</p>
				<button onclick="document.getElementById('welcome-banner').style.display='none'" class="btn btn-outline">
					Got it!
				</button>
			</div>
		</div>

		<!-- Account Header -->
		<div class="account-header">
			<div>
				<h1>My Account</h1>
				<p id="user-email" class="user-email"></p>
			</div>
			<button id="logout-btn" class="btn btn-outline">
				Logout
			</button>
		</div>

		<!-- Account Stats -->
		<div class="account-stats">
			<div class="stat-card">
				<div class="stat-icon">üì¶</div>
				<div class="stat-info">
					<div class="stat-value" id="total-orders">0</div>
					<div class="stat-label">Total Orders</div>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon">üíµ</div>
				<div class="stat-info">
					<div class="stat-value" id="total-spent">$0</div>
					<div class="stat-label">Total Spent</div>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon">‚è≥</div>
				<div class="stat-info">
					<div class="stat-value" id="pending-orders">0</div>
					<div class="stat-label">Pending Orders</div>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon">‚úì</div>
				<div class="stat-info">
					<div class="stat-value" id="completed-orders">0</div>
					<div class="stat-label">Completed</div>
				</div>
			</div>
		</div>

		<!-- Account Content -->
		<div class="account-content">
			<!-- Sidebar Navigation -->
			<div class="account-sidebar">
				<nav class="account-nav">
					<button class="nav-item active" data-section="orders">
						<span>üì¶</span>
						My Orders
					</button>
					<button class="nav-item" data-section="profile">
						<span>üë§</span>
						Profile
					</button>
					<button class="nav-item" data-section="addresses">
						<span>üìç</span>
						Addresses
					</button>
					<button class="nav-item" data-section="settings">
						<span>‚öôÔ∏è</span>
						Settings
					</button>
				</nav>
			</div>

			<!-- Main Content -->
			<div class="account-main">
				<!-- Orders Section -->
				<div id="orders-section" class="account-section active">
					<h2>My Orders</h2>
					<div id="orders-list" class="orders-list">
						<!-- Orders will be loaded here -->
					</div>
				</div>

				<!-- Profile Section -->
				<div id="profile-section" class="account-section">
					<h2>Profile Information</h2>
					<form id="profile-form" class="profile-form">
						<div class="form-row">
							<div class="form-group">
								<label for="profile-firstName">First Name</label>
								<input type="text" id="profile-firstName" name="firstName" required>
							</div>
							<div class="form-group">
								<label for="profile-lastName">Last Name</label>
								<input type="text" id="profile-lastName" name="lastName" required>
							</div>
						</div>
						<div class="form-group">
							<label for="profile-email">Email</label>
							<input type="email" id="profile-email" name="email" required>
						</div>
						<div class="form-group">
							<label for="profile-phone">Phone</label>
							<input type="tel" id="profile-phone" name="phone">
						</div>
						<button type="submit" class="btn btn-primary">Save Changes</button>
					</form>
				</div>

				<!-- Addresses Section -->
				<div id="addresses-section" class="account-section">
					<h2>Saved Addresses</h2>
					<p class="section-description">Manage your shipping and billing addresses</p>
					<div class="addresses-grid">
						<div class="address-card add-new">
							<div class="add-icon">+</div>
							<h4>Add New Address</h4>
							<p>Add a shipping or billing address</p>
						</div>
					</div>
				</div>

				<!-- Settings Section -->
				<div id="settings-section" class="account-section">
					<h2>Account Settings</h2>
					<div class="settings-list">
						<div class="setting-item">
							<div class="setting-info">
								<h4>Email Notifications</h4>
								<p>Receive order updates and promotions via email</p>
							</div>
							<label class="toggle">
								<input type="checkbox" checked>
								<span class="toggle-slider"></span>
							</label>
						</div>
						<div class="setting-item">
							<div class="setting-info">
								<h4>SMS Notifications</h4>
								<p>Get order status updates via text message</p>
							</div>
							<label class="toggle">
								<input type="checkbox">
								<span class="toggle-slider"></span>
							</label>
						</div>
						<div class="setting-item">
							<div class="setting-info">
								<h4>Marketing Emails</h4>
								<p>Receive exclusive deals and new arrivals</p>
							</div>
							<label class="toggle">
								<input type="checkbox" checked>
								<span class="toggle-slider"></span>
							</label>
						</div>
					</div>

					<div class="danger-zone">
						<h3>Danger Zone</h3>
						<button class="btn btn-danger" onclick="alert('Account deletion feature coming soon')">
							Delete Account
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</EcommerceLayout>

<style>
	.account-container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 2rem 1rem;
	}

	.welcome-banner {
		background: linear-gradient(135deg, #10b981, #059669);
		color: white;
		padding: 2rem;
		border-radius: 1rem;
		margin-bottom: 2rem;
		box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
	}

	.welcome-content {
		display: flex;
		align-items: center;
		gap: 2rem;
		flex-wrap: wrap;
	}

	.welcome-content h2 {
		margin: 0;
		flex: 1;
		min-width: 250px;
	}

	.welcome-content p {
		margin: 0;
		flex: 1;
		min-width: 250px;
		opacity: 0.9;
	}

	.account-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.account-header h1 {
		margin: 0;
		font-size: 2.5rem;
	}

	.user-email {
		color: var(--secondary-color);
		margin: 0.5rem 0 0 0;
	}

	.account-stats {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1.5rem;
		margin-bottom: 3rem;
	}

	.stat-card {
		background: white;
		padding: 1.5rem;
		border-radius: 1rem;
		border: 1px solid var(--border-color);
		display: flex;
		gap: 1rem;
		align-items: center;
		transition: all 0.3s;
	}

	.stat-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
	}

	.stat-icon {
		font-size: 2.5rem;
		background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.2));
		width: 60px;
		height: 60px;
		border-radius: 0.75rem;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.stat-value {
		font-size: 1.75rem;
		font-weight: 700;
		color: var(--text-color);
	}

	.stat-label {
		font-size: 0.875rem;
		color: var(--secondary-color);
	}

	.account-content {
		display: grid;
		grid-template-columns: 250px 1fr;
		gap: 2rem;
	}

	.account-sidebar {
		background: white;
		padding: 1.5rem;
		border-radius: 1rem;
		border: 1px solid var(--border-color);
		height: fit-content;
		position: sticky;
		top: 2rem;
	}

	.account-nav {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.nav-item {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 1rem;
		background: none;
		border: none;
		border-radius: 0.5rem;
		cursor: pointer;
		font-size: 1rem;
		font-weight: 500;
		color: var(--text-color);
		transition: all 0.2s;
		text-align: left;
	}

	.nav-item span {
		font-size: 1.25rem;
	}

	.nav-item:hover {
		background: var(--card-background);
	}

	.nav-item.active {
		background: var(--primary-color);
		color: white;
	}

	.account-main {
		background: white;
		padding: 2rem;
		border-radius: 1rem;
		border: 1px solid var(--border-color);
	}

	.account-section {
		display: none;
	}

	.account-section.active {
		display: block;
	}

	.account-section h2 {
		margin-bottom: 1.5rem;
		font-size: 1.75rem;
	}

	.section-description {
		color: var(--secondary-color);
		margin-bottom: 2rem;
	}

	.orders-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.order-card {
		padding: 1.5rem;
		border: 1px solid var(--border-color);
		border-radius: 0.75rem;
		transition: all 0.2s;
	}

	.order-card:hover {
		box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
	}

	.order-header {
		display: flex;
		justify-content: space-between;
		align-items: start;
		margin-bottom: 1rem;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.order-number {
		font-weight: 600;
		font-size: 1.125rem;
	}

	.order-status {
		padding: 0.375rem 0.75rem;
		border-radius: 1rem;
		font-size: 0.875rem;
		font-weight: 600;
	}

	.order-status.pending {
		background: #fef3c7;
		color: #92400e;
	}

	.order-status.processing {
		background: #dbeafe;
		color: #1e40af;
	}

	.order-status.shipped {
		background: #d1fae5;
		color: #065f46;
	}

	.order-status.delivered {
		background: #dcfce7;
		color: #166534;
	}

	.order-items {
		display: flex;
		gap: 0.5rem;
		margin-bottom: 1rem;
	}

	.order-item-img {
		width: 60px;
		height: 60px;
		border-radius: 0.5rem;
		object-fit: cover;
	}

	.order-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding-top: 1rem;
		border-top: 1px solid var(--border-color);
	}

	.order-total {
		font-weight: 600;
		font-size: 1.125rem;
	}

	.empty-state {
		text-align: center;
		padding: 4rem 2rem;
	}

	.empty-icon {
		font-size: 4rem;
		margin-bottom: 1rem;
		opacity: 0.5;
	}

	.empty-state h3 {
		margin-bottom: 0.5rem;
		color: var(--text-color);
	}

	.empty-state p {
		color: var(--secondary-color);
		margin-bottom: 2rem;
	}

	.profile-form {
		max-width: 600px;
	}

	.form-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1rem;
		margin-bottom: 1.5rem;
	}

	.form-group {
		display: flex;
		flex-direction: column;
		margin-bottom: 1.5rem;
	}

	.form-group label {
		margin-bottom: 0.5rem;
		font-weight: 600;
	}

	.form-group input {
		padding: 0.75rem;
		border: 2px solid var(--border-color);
		border-radius: 0.5rem;
		font-size: 1rem;
	}

	.form-group input:focus {
		outline: none;
		border-color: var(--primary-color);
	}

	.addresses-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 1.5rem;
	}

	.address-card {
		padding: 2rem;
		border: 2px dashed var(--border-color);
		border-radius: 0.75rem;
		text-align: center;
		cursor: pointer;
		transition: all 0.2s;
	}

	.address-card:hover {
		border-color: var(--primary-color);
		background: rgba(37, 99, 235, 0.05);
	}

	.add-icon {
		font-size: 3rem;
		color: var(--primary-color);
		margin-bottom: 1rem;
	}

	.address-card h4 {
		margin-bottom: 0.5rem;
	}

	.address-card p {
		color: var(--secondary-color);
		font-size: 0.875rem;
	}

	.settings-list {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		margin-bottom: 3rem;
	}

	.setting-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1.5rem;
		background: var(--card-background);
		border-radius: 0.75rem;
		border: 1px solid var(--border-color);
	}

	.setting-item h4 {
		margin-bottom: 0.25rem;
	}

	.setting-item p {
		color: var(--secondary-color);
		font-size: 0.875rem;
		margin: 0;
	}

	.toggle {
		position: relative;
		display: inline-block;
		width: 50px;
		height: 28px;
	}

	.toggle input {
		opacity: 0;
		width: 0;
		height: 0;
	}

	.toggle-slider {
		position: absolute;
		cursor: pointer;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: #ccc;
		transition: 0.3s;
		border-radius: 28px;
	}

	.toggle-slider:before {
		position: absolute;
		content: "";
		height: 20px;
		width: 20px;
		left: 4px;
		bottom: 4px;
		background-color: white;
		transition: 0.3s;
		border-radius: 50%;
	}

	.toggle input:checked + .toggle-slider {
		background-color: var(--primary-color);
	}

	.toggle input:checked + .toggle-slider:before {
		transform: translateX(22px);
	}

	.danger-zone {
		padding: 2rem;
		background: #fef2f2;
		border: 1px solid #fecaca;
		border-radius: 0.75rem;
	}

	.danger-zone h3 {
		color: #dc2626;
		margin-bottom: 1rem;
	}

	.btn-danger {
		background: #dc2626;
		color: white;
	}

	.btn-danger:hover {
		background: #b91c1c;
	}

	@media (max-width: 968px) {
		.account-content {
			grid-template-columns: 1fr;
		}

		.account-sidebar {
			position: static;
		}

		.account-nav {
			flex-direction: row;
			overflow-x: auto;
		}

		.nav-item {
			white-space: nowrap;
		}
	}

	@media (max-width: 640px) {
		.account-header h1 {
			font-size: 2rem;
		}

		.account-stats {
			grid-template-columns: repeat(2, 1fr);
		}

		.form-row {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	import { authManager } from '../stores/auth';
	import { orderManager } from '../stores/orders';

	// Check authentication
	if (!authManager.isAuthenticated()) {
		window.location.href = '/login?return=/account';
	}

	// Load user data
	const user = authManager.getCurrentUser();
	if (user) {
		// Display user email
		const userEmailEl = document.getElementById('user-email');
		if (userEmailEl) {
			userEmailEl.textContent = user.email;
		}

		// Load profile form
		const firstNameInput = document.getElementById('profile-firstName') as HTMLInputElement;
		const lastNameInput = document.getElementById('profile-lastName') as HTMLInputElement;
		const emailInput = document.getElementById('profile-email') as HTMLInputElement;
		const phoneInput = document.getElementById('profile-phone') as HTMLInputElement;

		if (firstNameInput) firstNameInput.value = user.firstName;
		if (lastNameInput) lastNameInput.value = user.lastName;
		if (emailInput) emailInput.value = user.email;
		if (phoneInput && user.phone) phoneInput.value = user.phone;

		// Load orders
		loadOrders(user.id);

		// Load stats
		loadStats(user.id);
	}

	// Show welcome banner if new user
	const urlParams = new URLSearchParams(window.location.search);
	if (urlParams.get('welcome') === 'true') {
		const banner = document.getElementById('welcome-banner');
		if (banner) {
			banner.style.display = 'block';
		}
	}

	// Logout handler
	const logoutBtn = document.getElementById('logout-btn');
	if (logoutBtn) {
		logoutBtn.addEventListener('click', () => {
			if (confirm('Are you sure you want to logout?')) {
				authManager.logout();
				window.location.href = '/';
			}
		});
	}

	// Navigation
	const navItems = document.querySelectorAll('.nav-item');
	const sections = document.querySelectorAll('.account-section');

	navItems.forEach(item => {
		item.addEventListener('click', () => {
			const sectionId = item.getAttribute('data-section');

			// Update nav
			navItems.forEach(nav => nav.classList.remove('active'));
			item.classList.add('active');

			// Update sections
			sections.forEach(section => section.classList.remove('active'));
			const targetSection = document.getElementById(`${sectionId}-section`);
			if (targetSection) {
				targetSection.classList.add('active');
			}
		});
	});

	// Profile form submission
	const profileForm = document.getElementById('profile-form');
	if (profileForm) {
		profileForm.addEventListener('submit', (e) => {
			e.preventDefault();
			const formData = new FormData(profileForm as HTMLFormElement);

			const result = authManager.updateProfile({
				firstName: formData.get('firstName') as string,
				lastName: formData.get('lastName') as string,
				email: formData.get('email') as string,
				phone: formData.get('phone') as string
			});

			if (result.success) {
				alert('Profile updated successfully!');
			} else {
				alert(result.error || 'Failed to update profile');
			}
		});
	}

	// Load orders
	function loadOrders(userId: string) {
		const ordersList = document.getElementById('orders-list');
		if (!ordersList) return;

		const orders = orderManager.getUserOrders(userId);

		if (orders.length === 0) {
			ordersList.innerHTML = `
				<div class="empty-state">
					<div class="empty-icon">üì¶</div>
					<h3>No orders yet</h3>
					<p>Start shopping to see your orders here</p>
					<a href="/products" class="btn btn-primary">Start Shopping</a>
				</div>
			`;
			return;
		}

		ordersList.innerHTML = orders.map(order => `
			<div class="order-card">
				<div class="order-header">
					<div>
						<div class="order-number">Order #${order.orderNumber}</div>
						<div style="color: var(--secondary-color); font-size: 0.875rem; margin-top: 0.25rem;">
							${order.createdAt.toLocaleDateString()}
						</div>
					</div>
					<span class="order-status ${order.status}">${order.status}</span>
				</div>
				<div class="order-items">
					${order.items.slice(0, 4).map(item => {
						const img = item.product?.images?.find((i: any) => i.isPrimary) || item.product?.images?.[0];
						return `<img src="${img?.url || ''}" alt="${item.product?.name || ''}" class="order-item-img">`;
					}).join('')}
					${order.items.length > 4 ? `<div class="order-item-img" style="display: flex; align-items: center; justify-content: center; background: var(--card-background);">+${order.items.length - 4}</div>` : ''}
				</div>
				<div class="order-footer">
					<div class="order-total">Total: $${order.total.toFixed(2)}</div>
					<a href="/order-details?id=${order.id}" class="btn btn-outline btn-sm">View Details</a>
				</div>
			</div>
		`).join('');
	}

	// Load stats
	function loadStats(userId: string) {
		const stats = orderManager.getOrderStats(userId);

		const totalOrdersEl = document.getElementById('total-orders');
		const totalSpentEl = document.getElementById('total-spent');
		const pendingOrdersEl = document.getElementById('pending-orders');
		const completedOrdersEl = document.getElementById('completed-orders');

		if (totalOrdersEl) totalOrdersEl.textContent = stats.totalOrders.toString();
		if (totalSpentEl) totalSpentEl.textContent = `$${stats.totalSpent.toFixed(2)}`;
		if (pendingOrdersEl) pendingOrdersEl.textContent = stats.pendingOrders.toString();
		if (completedOrdersEl) completedOrdersEl.textContent = stats.completedOrders.toString();
	}
</script>

