---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Orders Management">
  <!-- Filters and Search -->
  <div class="page-header">
    <div class="search-bar">
      <input type="text" id="search-orders" placeholder="Search orders..." class="search-input">
      <button class="btn btn-primary">üîç Search</button>
    </div>
    <div class="filter-controls">
      <select id="status-filter" class="filter-select">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <select id="date-filter" class="filter-select">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
      <button class="btn btn-outline" onclick="window.print()">üìÑ Export</button>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="stats-row">
    <div class="stat-box">
      <div class="stat-number" id="pending-count">0</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="processing-count">0</div>
      <div class="stat-label">Processing</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="shipped-count">0</div>
      <div class="stat-label">Shipped</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="delivered-count">0</div>
      <div class="stat-label">Delivered</div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="data-card">
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>
              <input type="checkbox" id="select-all">
            </th>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Items</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="orders-table-body">
          <tr>
            <td colspan="8" class="loading">Loading orders...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="order-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Order Details</h2>
        <button class="modal-close" onclick="closeOrderModal()">√ó</button>
      </div>
      <div class="modal-body" id="order-details">
        <!-- Order details will be loaded here -->
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .search-bar {
    display: flex;
    gap: 0.5rem;
    flex: 1;
    max-width: 500px;
  }

  .search-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--admin-border);
    border-radius: 0.5rem;
    font-size: 0.9375rem;
  }

  .filter-controls {
    display: flex;
    gap: 0.5rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid var(--admin-border);
    border-radius: 0.5rem;
    background: white;
    font-size: 0.9375rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
  }

  .btn-primary {
    background: var(--admin-primary);
    color: white;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-outline {
    background: white;
    border: 1px solid var(--admin-border);
    color: var(--admin-text);
  }

  .btn-outline:hover {
    background: var(--admin-bg);
  }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-box {
    background: white;
    padding: 1.5rem;
    border-radius: 0.75rem;
    border: 1px solid var(--admin-border);
    text-align: center;
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--admin-primary);
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--admin-text-secondary);
  }

  .data-card {
    background: white;
    border-radius: 0.75rem;
    border: 1px solid var(--admin-border);
    overflow: hidden;
  }

  .table-responsive {
    overflow-x: auto;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th {
    text-align: left;
    padding: 1rem;
    background: var(--admin-bg);
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--admin-text-secondary);
    white-space: nowrap;
  }

  .admin-table td {
    padding: 1rem;
    border-top: 1px solid var(--admin-border);
  }

  .admin-table td.loading {
    text-align: center;
    color: var(--admin-text-secondary);
  }

  .status-badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-badge.pending { background: #fef3c7; color: #92400e; }
  .status-badge.processing { background: #dbeafe; color: #1e40af; }
  .status-badge.shipped { background: #d1fae5; color: #065f46; }
  .status-badge.delivered { background: #dcfce7; color: #166534; }
  .status-badge.cancelled { background: #fee2e2; color: #991b1b; }

  .action-btns {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .action-btn.view {
    background: #dbeafe;
    color: #1e40af;
  }

  .action-btn.edit {
    background: #fef3c7;
    color: #92400e;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 0.75rem;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--admin-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--admin-text-secondary);
  }

  .modal-body {
    padding: 1.5rem;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }

    .search-bar {
      max-width: none;
    }

    .filter-controls {
      flex-wrap: wrap;
    }
  }
</style>

<script>
  import { orderManager } from '../../stores/orders';

  let allOrders: any[] = [];

  async function loadOrders() {
    try {
      const { authManager } = await import('../../stores/auth.js');
      const user = authManager.getCurrentUser();

      if (!user) {
        window.location.href = '/login?return=/admin/orders';
        return;
      }

      // Load all orders (in production, this would be all users' orders)
      allOrders = orderManager.getUserOrders(user.id);

      // Update stats
      updateStats(allOrders);

      // Display orders
      displayOrders(allOrders);

    } catch (error) {
      console.error('Failed to load orders:', error);
    }
  }

  function updateStats(orders: any[]) {
    const pending = orders.filter(o => o.status === 'pending').length;
    const processing = orders.filter(o => o.status === 'processing').length;
    const shipped = orders.filter(o => o.status === 'shipped').length;
    const delivered = orders.filter(o => o.status === 'delivered').length;

    document.getElementById('pending-count')!.textContent = pending.toString();
    document.getElementById('processing-count')!.textContent = processing.toString();
    document.getElementById('shipped-count')!.textContent = shipped.toString();
    document.getElementById('delivered-count')!.textContent = delivered.toString();
  }

  function displayOrders(orders: any[]) {
    const tbody = document.getElementById('orders-table-body');
    if (!tbody) return;

    if (orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="loading">No orders found</td></tr>';
      return;
    }

    tbody.innerHTML = orders.map(order => `
      <tr>
        <td><input type="checkbox" value="${order.id}"></td>
        <td><strong>${order.orderNumber}</strong></td>
        <td>${order.shippingAddress.firstName} ${order.shippingAddress.lastName}</td>
        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
        <td>${order.items.length} items</td>
        <td><strong>$${order.total.toFixed(2)}</strong></td>
        <td><span class="status-badge ${order.status}">${order.status}</span></td>
        <td>
          <div class="action-btns">
            <button class="action-btn view" onclick="viewOrder('${order.id}')">View</button>
            <button class="action-btn edit" onclick="updateOrderStatus('${order.id}')">Update</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function viewOrder(orderId: string) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    const modal = document.getElementById('order-modal');
    const detailsContainer = document.getElementById('order-details');

    if (modal && detailsContainer) {
      detailsContainer.innerHTML = `
        <div>
          <h3>Order ${order.orderNumber}</h3>
          <p><strong>Status:</strong> <span class="status-badge ${order.status}">${order.status}</span></p>
          <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
          <p><strong>Total:</strong> $${order.total.toFixed(2)}</p>
          
          <h4 style="margin-top: 1.5rem;">Customer Information</h4>
          <p><strong>Name:</strong> ${order.shippingAddress.firstName} ${order.shippingAddress.lastName}</p>
          <p><strong>Email:</strong> ${order.shippingAddress.email}</p>
          <p><strong>Phone:</strong> ${order.shippingAddress.phone}</p>
          
          <h4 style="margin-top: 1.5rem;">Shipping Address</h4>
          <p>${order.shippingAddress.address}</p>
          <p>${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.zipCode}</p>
          <p>${order.shippingAddress.country}</p>
          
          <h4 style="margin-top: 1.5rem;">Items</h4>
          ${order.items.map((item: any) => `
            <div style="border-top: 1px solid var(--admin-border); padding: 1rem 0;">
              <p><strong>${item.product.name}</strong></p>
              <p>Quantity: ${item.quantity} √ó $${item.variant?.price || item.product.price}</p>
            </div>
          `).join('')}
        </div>
      `;

      modal.classList.add('active');
    }
  }

  function closeOrderModal() {
    const modal = document.getElementById('order-modal');
    if (modal) {
      modal.classList.remove('active');
    }
  }

  function updateOrderStatus(orderId: string) {
    const newStatus = prompt('Enter new status (pending/processing/shipped/delivered/cancelled):');
    if (!newStatus) return;

    const validStatuses = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];
    if (!validStatuses.includes(newStatus)) {
      alert('Invalid status');
      return;
    }

    const result = orderManager.updateOrderStatus(orderId, newStatus as any);
    if (result.success) {
      alert('Order status updated successfully');
      loadOrders();
    } else {
      alert('Failed to update order status');
    }
  }

  // Filter handlers
  document.getElementById('status-filter')?.addEventListener('change', (e) => {
    const status = (e.target as HTMLSelectElement).value;
    const filtered = status ? allOrders.filter(o => o.status === status) : allOrders;
    displayOrders(filtered);
  });

  // Make functions global
  (window as any).viewOrder = viewOrder;
  (window as any).closeOrderModal = closeOrderModal;
  (window as any).updateOrderStatus = updateOrderStatus;

  // Load orders on page load
  loadOrders();
</script>

