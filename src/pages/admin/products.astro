---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Products Management">
  <!-- Page Header -->
  <div class="page-header">
    <div class="search-bar">
      <input type="text" id="search-products" placeholder="Search products..." class="search-input">
      <button class="btn btn-primary">üîç Search</button>
    </div>
    <div class="header-actions">
      <select id="category-filter" class="filter-select">
        <option value="">All Categories</option>
        <option value="women">Women</option>
        <option value="men">Men</option>
        <option value="accessories">Accessories</option>
      </select>
      <button class="btn btn-success" onclick="alert('Add product feature coming soon!')">
        ‚ûï Add Product
      </button>
    </div>
  </div>

  <!-- Products Grid -->
  <div class="products-grid" id="products-grid">
    <div class="loading">Loading products...</div>
  </div>
</AdminLayout>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .search-bar {
    display: flex;
    gap: 0.5rem;
    flex: 1;
    max-width: 500px;
  }

  .search-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--admin-border);
    border-radius: 0.5rem;
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid var(--admin-border);
    border-radius: 0.5rem;
    background: white;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--admin-primary);
    color: white;
  }

  .btn-success {
    background: var(--admin-success);
    color: white;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: var(--admin-text-secondary);
  }

  .product-card {
    background: white;
    border-radius: 0.75rem;
    border: 1px solid var(--admin-border);
    overflow: hidden;
    transition: all 0.2s;
  }

  .product-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .product-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
  }

  .product-info {
    padding: 1rem;
  }

  .product-name {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .product-category {
    font-size: 0.75rem;
    color: var(--admin-text-secondary);
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .product-price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--admin-primary);
    margin-bottom: 0.75rem;
  }

  .product-stock {
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .stock-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .stock-badge.in-stock {
    background: #dcfce7;
    color: #166534;
  }

  .stock-badge.low-stock {
    background: #fef3c7;
    color: #92400e;
  }

  .stock-badge.out-of-stock {
    background: #fee2e2;
    color: #991b1b;
  }

  .product-actions {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-btn.edit {
    background: var(--admin-primary);
    color: white;
  }

  .action-btn.delete {
    background: var(--admin-danger);
    color: white;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }

    .search-bar {
      max-width: none;
    }

    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
  }
</style>

<script>
  import { mockProducts } from '../../utils/mock-data';

  const API_BASE_URL = 'http://localhost:3001/api';
  let products = [...mockProducts]; // Start with mock data

  // Try to fetch from backend API
  async function fetchProducts() {
    try {
      const response = await fetch(`${API_BASE_URL}/products`);
      if (response.ok) {
        const data = await response.json();
        if (data.products && data.products.length > 0) {
          products = data.products;
          console.log('Loaded products from backend API');
        }
      }
    } catch (error) {
      console.log('Backend not available, using mock data');
    }
    loadProducts();
  }

  function loadProducts(filterCategory?: string) {
    const grid = document.getElementById('products-grid');
    if (!grid) return;

    let displayProducts = filterCategory
      ? products.filter(p => p.category.toLowerCase() === filterCategory.toLowerCase())
      : products;

    if (displayProducts.length === 0) {
      grid.innerHTML = '<div class="loading">No products found</div>';
      return;
    }

    grid.innerHTML = displayProducts.map(product => {
      const primaryImage = product.images?.find((img: any) => img.isPrimary) || product.images?.[0];
      const stock = product.stock || Math.floor(Math.random() * 100);
      const stockStatus = stock > 20 ? 'in-stock' : stock > 0 ? 'low-stock' : 'out-of-stock';
      const stockLabel = stock > 20 ? 'In Stock' : stock > 0 ? `Low Stock (${stock})` : 'Out of Stock';

      return `
        <div class="product-card">
          <img src="${primaryImage?.url || 'https://via.placeholder.com/300'}" alt="${product.name}" class="product-image">
          <div class="product-info">
            <div class="product-category">${product.category}</div>
            <div class="product-name">${product.name}</div>
            <div class="product-price">$${Number(product.price).toFixed(2)}</div>
            <div class="product-stock">
              <span class="stock-badge ${stockStatus}">${stockLabel}</span>
            </div>
            <div class="product-actions">
              <button class="action-btn edit" onclick="editProduct('${product.id}')">
                ‚úèÔ∏è Edit
              </button>
              <button class="action-btn delete" onclick="deleteProduct('${product.id}')">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  async function editProduct(productId: string) {
    alert(`Edit product ${productId} - Feature coming soon!`);
  }

  async function deleteProduct(productId: string) {
    if (confirm('Are you sure you want to delete this product?')) {
      try {
        const token = localStorage.getItem('auth_token');
        const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          products = products.filter(p => p.id !== productId);
          loadProducts();
          alert('Product deleted successfully!');
        } else {
          alert('Failed to delete product');
        }
      } catch (error) {
        // Fallback: remove locally
        products = products.filter(p => p.id !== productId);
        loadProducts();
        alert('Product removed (locally)');
      }
    }
  }

  // Make functions global
  (window as any).editProduct = editProduct;
  (window as any).deleteProduct = deleteProduct;

  // Initial load - try API first
  fetchProducts();

  // Category filter
  document.getElementById('category-filter')?.addEventListener('change', (e) => {
    const category = (e.target as HTMLSelectElement).value;
    loadProducts(category || undefined);
  });

  // Search
  document.getElementById('search-products')?.addEventListener('input', (e) => {
    const search = (e.target as HTMLInputElement).value.toLowerCase();
    const grid = document.getElementById('products-grid');
    if (!grid) return;

    const filtered = search
      ? products.filter(p => p.name.toLowerCase().includes(search) || p.description?.toLowerCase().includes(search))
      : products;

    if (filtered.length === 0) {
      grid.innerHTML = '<div class="loading">No products found</div>';
      return;
    }

    products = filtered;
    loadProducts();
    products = [...mockProducts]; // Reset for next search
  });
</script>

