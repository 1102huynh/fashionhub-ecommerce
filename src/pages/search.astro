---
import EcommerceLayout from '../layouts/EcommerceLayout.astro';
---

<EcommerceLayout title="Search Products - FashionHub" description="Find your perfect style">
  <div class="search-page">
    <!-- Search Header -->
    <div class="search-header">
      <h1>Search Products</h1>
      <form class="search-form" id="search-form">
        <input
          type="text"
          id="search-input"
          placeholder="Search for products..."
          class="search-input"
          autofocus
        >
        <button type="submit" class="btn btn-primary">
          üîç Search
        </button>
      </form>
    </div>

    <!-- Search Results -->
    <div id="search-results">
      <div class="search-info">
        <p>Start typing to search for products</p>
      </div>
    </div>
  </div>
</EcommerceLayout>

<style>
  .search-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .search-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .search-header h1 {
    font-size: 2.5rem;
    margin-bottom: 2rem;
  }

  .search-form {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    gap: 1rem;
  }

  .search-input {
    flex: 1;
    padding: 1rem 1.5rem;
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .search-info {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--secondary-color);
    font-size: 1.125rem;
  }

  .results-header {
    margin-bottom: 2rem;
  }

  .results-count {
    font-size: 1.125rem;
    color: var(--secondary-color);
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
  }

  .no-results {
    text-align: center;
    padding: 4rem 2rem;
  }

  .no-results-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .no-results h2 {
    font-size: 1.75rem;
    margin-bottom: 1rem;
  }

  .no-results p {
    color: var(--secondary-color);
    margin-bottom: 2rem;
  }

  @media (max-width: 768px) {
    .search-header h1 {
      font-size: 2rem;
    }

    .search-form {
      flex-direction: column;
    }

    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
  }
</style>

<script>
  import { mockProducts } from '../utils/mock-data';
  import ProductCardEnhanced from '../components/ecommerce/ProductCardEnhanced.astro';

  const searchForm = document.getElementById('search-form') as HTMLFormElement;
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const resultsContainer = document.getElementById('search-results');

  // Get search query from URL
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q') || '';
  if (initialQuery && searchInput) {
    searchInput.value = initialQuery;
    performSearch(initialQuery);
  }

  // Handle search form submission
  searchForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const query = searchInput.value.trim();
    if (query) {
      // Update URL
      const newUrl = `${window.location.pathname}?q=${encodeURIComponent(query)}`;
      window.history.pushState({}, '', newUrl);

      // Perform search
      performSearch(query);
    }
  });

  // Live search as user types
  let searchTimeout: number;
  searchInput?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = (e.target as HTMLInputElement).value.trim();

    if (query.length >= 2) {
      searchTimeout = window.setTimeout(() => {
        performSearch(query);
      }, 300);
    } else if (query.length === 0) {
      showInitialState();
    }
  });

  function performSearch(query: string) {
    if (!resultsContainer) return;

    const lowerQuery = query.toLowerCase();

    // Search products
    const results = mockProducts.filter(product =>
      product.name.toLowerCase().includes(lowerQuery) ||
      product.description.toLowerCase().includes(lowerQuery) ||
      product.category.toLowerCase().includes(lowerQuery)
    );

    displayResults(results, query);
  }

  function displayResults(products: any[], query: string) {
    if (!resultsContainer) return;

    if (products.length === 0) {
      resultsContainer.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">üîç</div>
          <h2>No products found</h2>
          <p>We couldn't find any products matching "<strong>${query}</strong>"</p>
          <a href="/products" class="btn btn-primary">Browse All Products</a>
        </div>
      `;
      return;
    }

    const resultsHtml = `
      <div class="results-header">
        <p class="results-count">Found <strong>${products.length}</strong> ${products.length === 1 ? 'product' : 'products'} for "<strong>${query}</strong>"</p>
      </div>
      <div class="products-grid">
        ${products.map(product => {
          const primaryImage = product.images.find((img: any) => img.isPrimary) || product.images[0];
          return `
            <div class="product-card">
              <a href="/products/${product.id}" class="product-link">
                <div class="product-image-container">
                  <img src="${primaryImage.url}" alt="${product.name}" class="product-image">
                  ${product.salePrice ? '<span class="sale-badge">Sale</span>' : ''}
                </div>
                <div class="product-info">
                  <div class="product-category">${product.category}</div>
                  <h3 class="product-name">${product.name}</h3>
                  <div class="product-price">
                    ${product.salePrice ? 
                      `<span class="price-sale">$${product.salePrice.toFixed(2)}</span>
                       <span class="price-original">$${product.price.toFixed(2)}</span>` :
                      `<span class="price">$${product.price.toFixed(2)}</span>`
                    }
                  </div>
                </div>
              </a>
            </div>
          `;
        }).join('')}
      </div>
    `;

    resultsContainer.innerHTML = resultsHtml;
  }

  function showInitialState() {
    if (!resultsContainer) return;

    resultsContainer.innerHTML = `
      <div class="search-info">
        <p>Start typing to search for products</p>
      </div>
    `;
  }
</script>

<style is:global>
  .product-card {
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: all 0.3s;
  }

  .product-card:hover {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    transform: translateY(-4px);
  }

  .product-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .product-image-container {
    position: relative;
    overflow: hidden;
    aspect-ratio: 3/4;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .product-card:hover .product-image {
    transform: scale(1.05);
  }

  .sale-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #ef4444;
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .product-info {
    padding: 1.5rem;
  }

  .product-category {
    font-size: 0.75rem;
    color: var(--secondary-color);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .product-name {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-color);
  }

  .product-price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .price,
  .price-sale {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .price-original {
    font-size: 1rem;
    color: var(--secondary-color);
    text-decoration: line-through;
  }
</style>

